@using Microsoft.AspNetCore.Html
@using UI.Plan.Web.ClassExtensions
@model EventCalendarViewModel

@{
    ViewBag.Title = "Event Month";

    var today = DateTime.Today;
    var currentDay = today.Day - 1;
    var dayIndex = 0;

    IEnumerable<Event> dayEvents;
}

@functions
{

    IHtmlContent PrintEvents(int dayNumber, DateTime today)
    {
        if (dayNumber >= Model.DaysInMonth) return null;
        var day = new DateTime(today.Year, today.Month, dayNumber);

        var dayEvent = Model.MonthEvents.FirstOrDefault(evt => evt.StartDate?.Year == day.Year && evt.StartDate?.Month == day.Month && evt.StartDate?.Day == day.Day);
        if (@dayEvent?.StartDate == null) return null;
        return Html.Raw($"<div class=\"event\"> " +
                            $"<span>Title: {@dayEvent.Title}</span> " +
                            $"<span>StartDate: {@dayEvent.StartDate?.ToString("HH:mm")}</span> " +
                            $"</div>");
    }
    
    IEnumerable<Event> DayEvents (int dayNumber, DateTime today)
    {
        if (dayNumber >= Model.DaysInMonth) return null;
        var day = new DateTime(today.Year, today.Month, dayNumber);
        // rewrite to ul li
        return Model.MonthEvents.Where(evt => evt.StartDate?.Year == day.Year && evt.StartDate?.Month == day.Month && evt.StartDate?.Day == day.Day);

    }

}

<h2>@ViewBag.Title</h2>

<div class="calendar">
<div>
    <a asp-controller="PlanManager" asp-action="Index" asp-route-year="@Model.Date.AddMonths(-1).Year" asp-route-month="@Model.Date.AddMonths(-1).Month" >Previous Month</a>
    <a asp-controller="PlanManager" asp-action="Index" asp-route-year="@Model.Date.AddMonths(1).Year" asp-route-month="@Model.Date.AddMonths(1).Month" >Next Month</a>
</div>
    @Model.Date.ToString("MMMM yyyy")
    <table border="1" width="100%" cellpadding="5">
        <tr>
            <th>понедельник</th>
            <th>вторник</th>
            <th>среда</th>
            <th>четверг</th>
            <th>пятница</th>
            <th>суббота</th>
            <th>воскресенье</th>
        </tr>
        @for (var i = 0; i < Model.RowCount; i++)
        {
            <tr>
                @for (var j = 0; j < Model.ColumnCount; j++)
                {
                    if (j >= Model.Date.DayOfWeek.ToRusInt() - 1 || i > 0)
                    {
                        var tdClass = dayIndex == currentDay && Model.Date.Year == today.Date.Year && Model.Date.Month  == today.Date.Month
                            ? "highlight"
                            : "";
                        <td class="@(tdClass)">
                            @(dayIndex++ < Model.DaysInMonth ? $"{dayIndex}." : "")
                            @{ dayEvents = DayEvents(dayIndex, Model.Date); }
                            @if (dayEvents != null)
                            {
                                @foreach (var dayEvent in dayEvents)
                                 {
                                     <div class="event"> 
                                         <span>Title: @dayEvent.Title</span>
                                         <span>StartDate: @dayEvent.StartDate?.ToString("HH:mm")</span>
                                     </div>
                                 }
                            }
                        </td>
                    }
                    else
                    {
                        <td></td>
                    }
                }
            </tr>
        }
    </table>

</div>


